<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Petitioners by Locality</title>
  <link rel="stylesheet" href="styles/index.css" />
</head>
<body>

  <h1>Petitioners by Locality</h1>
  <p>Select the constituencies_data.json file here.</p>
  <input type="file" id="fileInput" accept=".json" class="control" />

  <div class="controls-container" id="controlsContainer" style="display:none;">
    <select id="constituencySelect" class="control">
      <option disabled selected>Choose a constituency</option>
    </select>
    <input type="text" id="filterName" placeholder="Filter by petition name" class="control">
    <input type="number" id="filterSignatures" placeholder="Min signatures" class="control">
    <label for="filterCreatedDate" class="control-label">Created after:</label>
    <input type="date" id="filterCreatedDate" class="control">
    <select id="filterSalienceArrow" class="control">
      <option value="all">Salience: All</option>
      <option value="up">More salient ‚Üë</option>
      <option value="down">Less salient ‚Üì</option>
    </select>
    <button id="toggleDetailsBtn" class="toggle-details-btn export-btn control">üìä Show Details</button>
    <button class="export-btn control" id="exportCsvBtn">‚¨áÔ∏è Export to CSV</button>
  </div>
<table id="dataTable">
  <colgroup id="overview-group" class="overview-group">
    <col /><col /></colgroup>
  <colgroup id="salience-group" class="salience-group">
    <col class="salience-col" /><col class="salience-col" /></colgroup>
  <colgroup id="uk-wide-info-group" class="uk-wide-info-group"> <col class="uk-wide-info-col" /><col class="uk-wide-info-col" /></colgroup>
  <colgroup id="details-group" class="details-group"> <col class="details-col" /><col class="details-col" /></colgroup>
  <thead>
    <tr>
      <th colspan="2" class="colgroup-header">Overview</th>
      <th colspan="2" class="colgroup-header salience-col salience-header">Local Salience</th>
      <th colspan="2" class="colgroup-header uk-wide-info-col uk-wide-info-header">UK-wide Info</th> <th colspan="2" class="colgroup-header details-col details-header">Details</th> </tr>
    <tr>
      <th data-sort="text">Petition</th>
      <th data-sort="number">Count</th>
      <th class="salience-col" data-sort="number">Actual:Expected Salience</th>
      <th class="salience-col"></th> <th class="uk-wide-info-col" data-sort="number">UK Total</th>
      <th class="uk-wide-info-col" data-sort="text">State</th>
      <th class="details-col" data-sort="date">Created</th>
      <th class="details-col"></th> </tr>
  </thead>
  <tbody>
  </tbody>
</table>

  <footer>
    Contains public sector information licensed under the Open Government Licence v3.0.
  </footer>

  <script>
    let fullData = {};
    let signaturesByConstituency = {};
    let rawPetitionsData = {};
    let currentDisplayed = [];
    let currentSortColumn = 1;
    let currentSortDirection = "desc";
    // Updated headerCellIndexMap based on new column positions
    // Table columns: Petition (0), Count (1), Salience (2), Arrow (3), UK Total (4), State (5), Created (6), Details Button (7)
    // data-sort indices: Petition (0), Count (1), Salience (2), UK Total (3), State (4), Created (5)
    // Mapping:
    // Petition: 0 -> cell 0
    // Count: 1 -> cell 1
    // Salience: 2 -> cell 2
    // UK Total: 3 -> cell 4
    // State: 4 -> cell 5
    // Created: 5 -> cell 6
    const headerCellIndexMap = [0, 1, 2, 4, 5, 6];

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          fullData = data;
          signaturesByConstituency = data.signaturesByConstituency || {};
          rawPetitionsData = data.rawPetitionsData || {};

          if (Array.isArray(rawPetitionsData)) {
            rawPetitionsData = Object.fromEntries(rawPetitionsData.map(p => [p.id, p]));
          }

          populateConstituencySelector(Object.keys(signaturesByConstituency));
          document.getElementById("controlsContainer").style.display = "flex";
        } catch (err) {
          alert("Error parsing JSON file.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    });

    function populateConstituencySelector(constituencies) {
      const select = document.getElementById("constituencySelect");
      select.innerHTML = `<option disabled selected>Choose a constituency</option>`;
      select.style.display = "inline-block";

      select.addEventListener("change", function() {
        const selected = this.value;
        const constituencyData = signaturesByConstituency[selected];
        const dataTable = document.getElementById("dataTable");
        const toggleDetailsBtn = document.getElementById("toggleDetailsBtn");

        dataTable.classList.remove("show-details");
        toggleDetailsBtn.textContent = "üìä Show Details";

        currentSortColumn = 1; // Default sort by Count
        currentSortDirection = "desc";

        populateTable(constituencyData);
        updateSortIndicator();
        const headers = document.querySelectorAll("th[data-sort]");
        if (headers[currentSortColumn]) {
          const sortType = headers[currentSortColumn].getAttribute("data-sort");
          sortTable(currentSortColumn, sortType, currentSortDirection);
        }
      });

      constituencies.sort().forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    function updateSortIndicator() {
      const headers = document.querySelectorAll("th[data-sort]");
      headers.forEach(h => h.removeAttribute("data-sort-direction"));
      if (currentSortColumn >= 0 && currentSortColumn < headers.length && headers[currentSortColumn]) {
        headers[currentSortColumn].setAttribute("data-sort-direction", currentSortDirection);
      }
    }

    document.getElementById("toggleDetailsBtn").addEventListener("click", function() {
      const table = document.getElementById("dataTable");
      const showing = table.classList.toggle("show-details");
      this.textContent = showing ? "üìä Hide Details" : "üìä Show Details";
    });

    function setupSortableColumns() {
      const headers = document.querySelectorAll("th[data-sort]");
      headers.forEach((header, index) => {
        header.addEventListener("click", function() {
          const sortType = this.getAttribute("data-sort");

          if (currentSortColumn === index) {
            currentSortDirection = currentSortDirection === "desc" ? "asc" : "desc";
          } else {
            currentSortColumn = index;
            currentSortDirection = "desc";
          }

          updateSortIndicator();
          sortTable(index, sortType, currentSortDirection);
        });
      });
    }

    function sortTable(columnIndex, sortType, direction) {
      const tbody = document.querySelector("#dataTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr:not(.petition-details-row)")); // Exclude detail rows from sorting

      const actualCellIndex = headerCellIndexMap[columnIndex];

      if (actualCellIndex === undefined) {
        console.error("Invalid columnIndex for sorting:", columnIndex);
        return;
      }

      rows.sort((rowA, rowB) => {
        const cellA = rowA.cells[actualCellIndex];
        const cellB = rowB.cells[actualCellIndex];
        if (!cellA || !cellB) return 0;

        let valueA, valueB;

        if (sortType === "date") {
          valueA = new Date(cellA.getAttribute("data-value") || 0);
          valueB = new Date(cellB.getAttribute("data-value") || 0);
        } else {
          valueA = cellA.hasAttribute("data-value") ? cellA.getAttribute("data-value") : cellA.textContent.trim();
          valueB = cellB.hasAttribute("data-value") ? cellB.getAttribute("data-value") : cellB.textContent.trim();
        }

        let comparison = 0;
        if (sortType === "number") {
          const numA = parseFloat(valueA.replace(/[,]+/g, "")) || 0;
          const numB = parseFloat(valueB.replace(/[,]+/g, "")) || 0;
          comparison = numA < numB ? -1 : (numA > numB ? 1 : 0);
        } else if (sortType === "date") {
          comparison = valueA.getTime() < valueB.getTime() ? -1 : (valueA.getTime() > valueB.getTime() ? 1 : 0);
        }
        else {
          comparison = valueA.localeCompare(valueB);
        }

        return direction === "asc" ? comparison : -comparison;
      });

      // Re-append rows along with their associated detail rows
      rows.forEach(row => {
        tbody.appendChild(row);
        const detailRowId = row.dataset.detailRowId;
        if (detailRowId) {
          const detailRow = document.getElementById(detailRowId);
          if (detailRow) {
            tbody.appendChild(detailRow);
          }
        }
      });
    }

    function applyFilters() {
      const nameFilter = document.getElementById('filterName').value.toLowerCase();
      const minSignatures = parseInt(document.getElementById('filterSignatures').value) || 0;
      const createdAfterDate = document.getElementById('filterCreatedDate').value; //YYYY-MM-DD
      const salienceArrowFilter = document.getElementById('filterSalienceArrow').value; // 'all', 'up', 'down'
      const tbody = document.querySelector("#dataTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr:not(.petition-details-row)"));

      rows.forEach(row => {
        let display = true;

        // Filter by name
        const petitionCell = row.cells[0];
        const petitionName = petitionCell ? petitionCell.querySelector('a')?.textContent.toLowerCase() : '';
        if (nameFilter && !petitionName.includes(nameFilter)) {
          display = false;
        }

        // Filter by minimum signatures
        const countCell = row.cells[1];
        const signatureCount = parseInt(countCell?.textContent.replace(/,/g, '')) || 0;
        if (signatureCount < minSignatures) {
          display = false;
        }

        // Filter by created date (now at index 6)
        const createdDateCell = row.cells[6]; // Get the created date cell
        const rawCreatedDate = createdDateCell ? createdDateCell.getAttribute("data-value") : null; // Get raw ISO date
        if (createdAfterDate && rawCreatedDate) {
          if (rawCreatedDate < createdAfterDate) { // Direct string comparison works for YYYY-MM-DD
            display = false;
          }
        } else if (createdAfterDate) {
          display = false; // If we can't get the created date, don't show if a date filter is active
        }

        // Filter by salience arrow
        const salienceCell = row.cells[2]; // Salience value is in cell 2
        const salienceValue = parseFloat(salienceCell?.getAttribute("data-value")) || 0;
        if (salienceArrowFilter === 'up' && salienceValue <= 1.0) {
          display = false;
        } else if (salienceArrowFilter === 'down' && salienceValue >= 1.0) {
          display = false;
        }

        row.style.display = display ? '' : 'none';

        // Also hide/show the associated detail row
        const detailRowId = row.dataset.detailRowId;
        if (detailRowId) {
          const detailRow = document.getElementById(detailRowId);
          if (detailRow) {
            detailRow.style.display = display ? 'none' : 'none'; // Always hide details initially
          }
        }
      });
    }

    function formatDateUK(isoDateString) {
      if (!isoDateString) return 'N/A';
      const date = new Date(isoDateString);
      // Check if the date is valid before formatting
      if (isNaN(date.getTime())) {
        return 'Invalid Date';
      }
      return date.toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function populateTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      currentDisplayed = [];

      if (!data || typeof data !== 'object') return;

      const sortedEntries = Object.entries(data).sort(([, a], [, b]) => b.count - a.count);

      let detailRowCounter = 0; // To create unique IDs for detail rows

      sortedEntries.forEach(([petition, details]) => {
        const row = document.createElement("tr");
        const petitionId = details.id;
        const petitionDetails = getPetitionDetails(petitionId);
        const createdDateISO = petitionDetails?.attributes?.created_at;
        const formattedCreatedDate = formatDateUK(createdDateISO);

        const detailRowId = `details-row-${petitionId}-${detailRowCounter++}`;
        row.dataset.detailRowId = detailRowId; // Link main row to its detail row

        const petitionCell = document.createElement("td");
        const link = document.createElement("a");
        link.href = `https://petition.parliament.uk/petitions/${petitionId}`;
        link.textContent = petition;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        petitionCell.appendChild(link);
        row.appendChild(petitionCell);

        const countCell = document.createElement("td");
        countCell.textContent = details.count.toLocaleString("en-UK");
        row.appendChild(countCell);

        const ukTotal = getUKTotal(petitionId);
        const expectedProportion = 1 / 650;
        const actualProportion = ukTotal > 0 ? (details.count / ukTotal) : 0;
        const salience = ukTotal > 0 ? (actualProportion / expectedProportion) : 0;
        const formattedSalience = salience.toFixed(2);

        const salienceCell = document.createElement("td");
        salienceCell.className = "salience-cell";
        salienceCell.textContent = formattedSalience;
        salienceCell.setAttribute("data-value", salience);
        row.appendChild(salienceCell);

        const salienceIndicatorCell = document.createElement("td");
        salienceIndicatorCell.className = "salience-cell";
        const salienceIndicator = document.createElement("div");
        salienceIndicator.className = "salience-arrow " + (salience > 1.0 ? "up" : "down");
        salienceIndicator.innerHTML = salience > 1.0 ? "‚Üë" : "‚Üì";
        if (Math.abs(salience - 1.0) < 0.01) {
          salienceIndicator.innerHTML = "";
          salienceIndicator.className = "salience-arrow";
        }
        salienceIndicatorCell.appendChild(salienceIndicator);
        row.appendChild(salienceIndicatorCell);

        // UK Total cell (now in uk-wide-info group)
        const ukTotalCell = document.createElement("td");
        ukTotalCell.className = "uk-wide-info-cell"; // Add uk-wide-info-cell class
        ukTotalCell.textContent = ukTotal ? ukTotal.toLocaleString("en-UK") : "N/A";
        ukTotalCell.setAttribute("data-value", ukTotal || 0);
        row.appendChild(ukTotalCell);

        // State cell (now in uk-wide-info group)
        const stateCell = document.createElement("td");
        stateCell.className = "uk-wide-info-cell"; // Add uk-wide-info-cell class
        stateCell.textContent = petitionDetails?.attributes?.state || "N/A";
        row.appendChild(stateCell);

        // New 'Created' date cell (now in details group)
        const createdCell = document.createElement("td");
        createdCell.className = "details-cell"; // Add details-cell class
        createdCell.textContent = formattedCreatedDate;
        createdCell.setAttribute("data-value", createdDateISO || ''); // Store ISO for sorting
        row.appendChild(createdCell);

        // Details button cell (now in details group)
        const detailsButtonCell = document.createElement("td");
        detailsButtonCell.className = "details-cell"; // Add details-cell class
        const detailsButton = document.createElement("button");
        detailsButton.textContent = "Show Info";
        detailsButton.classList.add("show-info-btn");
        detailsButtonCell.appendChild(detailsButton);
        row.appendChild(detailsButtonCell);

        tbody.appendChild(row);

        // Create the hidden details row
        const detailsRow = document.createElement("tr");
        detailsRow.id = detailRowId;
        detailsRow.classList.add("petition-details-row");
        detailsRow.style.display = 'none'; // Initially hidden

        const detailsContentCell = document.createElement("td");
        // Total columns in the table (Petition, Count, Salience, Arrow, UK Total, State, Created, Details Btn) = 8
        detailsContentCell.colSpan = 8;
        detailsContentCell.classList.add("petition-details-content");

        let contentHtml = '';
        if (petitionDetails) {
            contentHtml += `<strong>Background:</strong> <p>${petitionDetails.attributes.background || 'N/A'}</p>`;
            if (petitionDetails.attributes.additional_details) {
                contentHtml += `<strong>Additional Details:</strong> <p>${petitionDetails.attributes.additional_details}</p>`;
            }
            if (petitionDetails.government_response) {
                contentHtml += `<strong>Government Response:</strong> <p><em>Responded on: ${formatDateUK(petitionDetails.government_response.responded_on)}</em></p><p>${petitionDetails.government_response.summary || 'N/A'}</p>`;
                if (petitionDetails.government_response.details) {
                    contentHtml += `<p>${petitionDetails.government_response.details}</p>`;
                }
            }
            if (petitionDetails.debate) {
                contentHtml += `<strong>Debate Info:</strong> <p><em>Debated on: ${formatDateUK(petitionDetails.debate.debated_on)}</em></p>`;
                if (petitionDetails.debate.transcript_url) {
                    contentHtml += `<p><a href="${petitionDetails.debate.transcript_url}" target="_blank" rel="noopener noreferrer">Transcript</a></p>`;
                }
                if (petitionDetails.debate.video_url && petitionDetails.debate.video_url !== "https://www.youtube.com/watch?v=a1BAM81Twgk") {
                    contentHtml += `<p><a href="${petitionDetails.debate.video_url}" target="_blank" rel="noopener noreferrer">Video</a></p>`;
                }
                if (petitionDetails.debate.debate_pack_url) {
                    contentHtml += `<p><a href="${petitionDetails.debate.debate_pack_url}" target="_blank" rel="noopener noreferrer">Debate Pack</a></p>`;
                }
            }
        } else {
            contentHtml = '<p>No additional details available for this petition.</p>';
        }

        detailsContentCell.innerHTML = contentHtml;
        detailsRow.appendChild(detailsContentCell);
        tbody.appendChild(detailsRow);

        // Event listener for the details button
        detailsButton.addEventListener('click', function() {
          const isHidden = detailsRow.style.display === 'none';
          detailsRow.style.display = isHidden ? '' : 'none';
          this.textContent = isHidden ? 'Hide Info' : 'Show Info';
        });

        currentDisplayed.push({
          petition,
          count: details.count,
          created: createdDateISO, // Store ISO for export
          salience: formattedSalience,
          ukTotal,
          state: petitionDetails?.attributes?.state || null
        });
      });

      // Apply filters after populating the table
      applyFilters();
    }

    function getUKTotal(id) {
      const details = getPetitionDetails(id);
      return details?.attributes?.signature_count;
    }

    function getPetitionDetails(id) {
      return rawPetitionsData[id];
    }

    document.getElementById("exportCsvBtn").addEventListener("click", function() {
      if (currentDisplayed.length === 0) return;

      const csvHeader = "Petition,Count,Salience,UK Total,State,Created\n"; // Updated CSV header
      const csvRows = currentDisplayed.map(item =>
        `"${item.petition.replace(/"/g, '""')}",${item.count},${item.salience},${item.ukTotal ?? "N/A"},${item.state ?? "N/A"},"${formatDateUK(item.created)}"`
      ).join("\n");

      const csvString = csvHeader + csvRows;
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "petition_data.csv");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.addEventListener("DOMContentLoaded", function() {
      setupSortableColumns();

      const filterNameInput = document.getElementById('filterName');
      const filterSignaturesInput = document.getElementById('filterSignatures');
      const filterCreatedDateInput = document.getElementById('filterCreatedDate');
      const filterSalienceArrowInput = document.getElementById('filterSalienceArrow');

      filterNameInput.addEventListener('input', applyFilters);
      filterSignaturesInput.addEventListener('input', applyFilters);
      filterCreatedDateInput.addEventListener('input', applyFilters);
      filterSalienceArrowInput.addEventListener('change', applyFilters); // Use 'change' for select elements
    });
  </script>
</body>
</html>
