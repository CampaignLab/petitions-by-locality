<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Petitioners by Locality</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0 auto;
      padding: 2rem;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      max-width: 1200px;
      box-sizing: border-box;
    }

    h1 {
      margin-bottom: 1rem;
    }

    input[type="file"],
    select,
    button.export-btn {
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
    }

    .controls-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    table {
      width: 100%;
      max-width: 1000px;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    table colgroup:first-of-type col {
      background-color: #ffffff;
    }

    /* MODIFIED SECTION STARTS */
    table colgroup:nth-of-type(2) col {
      background-color: #f0fff3; /* Background for all columns in the 2nd group */
      /* border-left: 2px solid #ccc; */ /* Removed from here */
    }

    /* Rule for the dividing line between 1st and 2nd colgroup */
    table colgroup:nth-of-type(2) col:first-child {
      border-left: 2px solid #ccc; /* Applies only to the first column of the 2nd group */
    }
    /* MODIFIED SECTION ENDS */

    table colgroup:nth-of-type(3) col {
      background-color: #f9fafe;
      border-left: 2px solid #ccc; /* This rule remains, affecting all cols in 3rd group */
    }

    /* Only show vertical lines when details are revealed */
    .show-details td:nth-child(4) {
      border-right: 2px solid #999; /* Less intense vertical line */
    }

    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f1f1f1;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background-color: #e5e5e5;
    }

    th::after {
      content: '‚ÜïÔ∏è';
      opacity: 0.2;
      margin-left: 5px;
    }

    th[data-sort-direction="asc"]::after {
      content: '‚Üë';
      opacity: 1;
    }

    th[data-sort-direction="desc"]::after {
      content: '‚Üì';
      opacity: 1;
    }

    /* Only show vertical line in header when details are revealed */
    .show-details th:nth-child(4) {
      border-right: 2px solid #999;
    }
    
    /* Style for column group headers */
    .colgroup-header {
      text-align: center;
      background-color: #e5e5e5;
      font-weight: bold;
      padding: 0.5rem;
    }
    
    .colgroup-header.details-col {
      display: none;
    }
    
    .colgroup-header.salience-col {
      display: none;
    }
    
    .show-details .colgroup-header.details-col {
      display: table-cell;
    }

    .show-details .colgroup-header.salience-col {
      display: table-cell;
    }

    tr:nth-child(even) {
      background-color: #f6f6f6;
    }

    .details-col,
    .details-cell,
    .salience-col,
    .salience-cell {
      display: none;
    }

    .show-details .details-col,
    .show-details .details-cell,
    .show-details .salience-col,
    .show-details .salience-cell {
      display: table-cell;
    }

    .toggle-btn-cell {
      text-align: right;
    }

    .toggle-details-btn {
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-left: 0.5rem;
    }
    
    .salience-arrow {
      font-size: 20px;
      text-align: center;
      padding: 5px;
      border-radius: 4px;
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
    }
    
    .salience-arrow.up {
      background-color: #e6ffec;
      color: #2da44e;
    }
    
    .salience-arrow.down {
      background-color: #ffebe9;
      color: #cf222e;
    }

    footer {
      margin-top: auto;
      padding: 1rem;
      font-size: 0.85rem;
      color: #666;
      text-align: center;
    }

    @media (max-width: 600px) {
      .controls-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      table, thead, tbody, th, td, tr {
        display: block;
      }

      th {
        display: none;
      }

      td {
        position: relative;
        padding-left: 50%;
      }

      td::before {
        position: absolute;
        top: 0;
        left: 0;
        width: 50%;
        padding-left: 1rem;
        font-weight: bold;
        white-space: nowrap;
      }

      tr {
        margin-bottom: 1rem;
        border-bottom: 2px solid #ccc;
      }

      .toggle-btn-cell {
        text-align: left;
        padding-top: 1rem;
      }
      
      /* Remove the vertical line in mobile view as it's not needed */
      .show-details td:nth-child(2), .show-details th:nth-child(2) {
        border-right: none;
      }
    }
  </style>
</head>
<body>

  <h1>Petitioners by Locality</h1>
  <p>Select the constituencies_data.json file here.</p>
  <input type="file" id="fileInput" accept=".json" />
  
  <div class="controls-container" id="controlsContainer" style="display:none;">
    <select id="constituencySelect">
      <option disabled selected>Choose a constituency</option>
    </select>
    <button id="toggleDetailsBtn" class="toggle-details-btn export-btn">üìä Show Details</button>
    <button class="export-btn" id="exportCsvBtn">‚¨áÔ∏è Export to CSV</button>
  </div>

  <table id="dataTable">
    <colgroup>
      <col />
      <col />
    </colgroup>
    <colgroup class="salience-group">
      <col class="salience-col" />
      <col class="salience-col" />
    </colgroup>
    <colgroup class="detail-group">
      <col class="details-col" />
      <col class="details-col" />
    </colgroup>
    <thead>
      <tr>
        <td colspan="2" class="colgroup-header">Overview</td>
        <td colspan="2" class="colgroup-header salience-col">Local Salience</td>
        <td colspan="2" class="colgroup-header details-col">UK-wide Info</td>
      </tr>
      <tr>
        <th data-sort="text">Petition</th>
        <th data-sort="number">Count</th>
        <th class="salience-col" data-sort="number">Actual:Expected Salience</th>
        <th class="salience-col"></th>
        <th class="details-col" data-sort="number">UK Total</th>
        <th class="details-col" data-sort="text">State</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>

  <footer>
    Contains public sector information licensed under the Open Government Licence v3.0.
  </footer>

  <script>
    let fullData = {};
    let signaturesByConstituency = {};
    let rawPetitionsData = {};
    let currentDisplayed = [];
    // Default sort by "Count" (index 1 of sortable headers), descending
    let currentSortColumn = 1; 
    let currentSortDirection = "desc";
    // Maps the index of `th[data-sort]` elements to actual cell index in a row
    const headerCellIndexMap = [0, 1, 2, 4, 5]; 


    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          fullData = data;
          signaturesByConstituency = data.signaturesByConstituency || {};
          rawPetitionsData = data.rawPetitionsData || {};

          if (Array.isArray(rawPetitionsData)) {
            rawPetitionsData = Object.fromEntries(rawPetitionsData.map(p => [p.id, p]));
          }

          populateConstituencySelector(Object.keys(signaturesByConstituency));
          document.getElementById("controlsContainer").style.display = "flex";
        } catch (err) {
          alert("Error parsing JSON file.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    });

    function populateConstituencySelector(constituencies) {
      const select = document.getElementById("constituencySelect");
      select.innerHTML = `<option disabled selected>Choose a constituency</option>`;
      select.style.display = "inline-block";

      select.addEventListener("change", function () {
        const selected = this.value;
        const constituencyData = signaturesByConstituency[selected];
        document.getElementById("dataTable").classList.remove("show-details");
        document.getElementById("toggleDetailsBtn").textContent = "üìä Show Details";
        
        // Reset to default sort when constituency changes
        currentSortColumn = 1; // "Count" column (index 1 in sortable headers array)
        currentSortDirection = "desc";

        populateTable(constituencyData); // Populates based on data, initial sort inside is by count
        updateSortIndicator(); // Update UI to show "Count" sorted desc
        // Re-sort based on current sort state, ensuring consistency if populateTable's internal sort changes
        const headers = document.querySelectorAll("th[data-sort]");
        if (headers[currentSortColumn]) {
            const sortType = headers[currentSortColumn].getAttribute("data-sort");
            sortTable(currentSortColumn, sortType, currentSortDirection);
        }
      });

      constituencies.sort().forEach(name => { // Sort constituencies alphabetically
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }
    
    function updateSortIndicator() {
        const headers = document.querySelectorAll("th[data-sort]");
        headers.forEach(h => h.removeAttribute("data-sort-direction"));
        if (currentSortColumn >= 0 && currentSortColumn < headers.length && headers[currentSortColumn]) {
            headers[currentSortColumn].setAttribute("data-sort-direction", currentSortDirection);
        }
    }

    document.getElementById("toggleDetailsBtn").addEventListener("click", function () {
      const table = document.getElementById("dataTable");
      const showing = table.classList.toggle("show-details");
      this.textContent = showing ? "üìä Hide Details" : "üìä Show Details";
    });

    function setupSortableColumns() {
      const headers = document.querySelectorAll("th[data-sort]");
      headers.forEach((header) => { // No need for index here
        header.addEventListener("click", function() {
          const sortType = this.getAttribute("data-sort");
          // Find the index of the clicked header within the NodeList of sortable headers
          const columnIndex = Array.from(headers).indexOf(this); 
          
          if (currentSortColumn === columnIndex) {
            // Same column, toggle direction
            currentSortDirection = currentSortDirection === "desc" ? "asc" : "desc";
          } else {
            // New column, sort descending by default
            currentSortColumn = columnIndex;
            currentSortDirection = "desc"; 
          }
          
          updateSortIndicator();
          sortTable(columnIndex, sortType, currentSortDirection);
        });
      });
    }
    
    function sortTable(columnIndex, sortType, direction) {
      const tbody = document.querySelector("#dataTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      
      const actualCellIndex = headerCellIndexMap[columnIndex];
      if (actualCellIndex === undefined) {
        console.error("Invalid columnIndex for sorting:", columnIndex);
        return;
      }
      
      rows.sort((rowA, rowB) => {
        let valueA, valueB;
        const cellA = rowA.cells[actualCellIndex];
        const cellB = rowB.cells[actualCellIndex];

        if (!cellA || !cellB) return 0; // Should not happen with correct mapping
        
        // Prioritize data-value attribute for sorting if available (typically for numbers)
        if (cellA.hasAttribute("data-value") && cellB.hasAttribute("data-value")) {
          valueA = parseFloat(cellA.getAttribute("data-value"));
          valueB = parseFloat(cellB.getAttribute("data-value"));
        } else {
          valueA = cellA.textContent.trim();
          valueB = cellB.textContent.trim();
          
          if (sortType === "number") {
            valueA = parseFloat(valueA.replace(/[,]+/g, "")) || 0; // Remove commas for parsing
            valueB = parseFloat(valueB.replace(/[,]+/g, "")) || 0; // Remove commas for parsing
          }
        }
        
        if (valueA === valueB) return 0;
        
        let comparison = 0;
        if (valueA < valueB) {
            comparison = -1;
        } else if (valueA > valueB) {
            comparison = 1;
        }

        return direction === "asc" ? comparison : -comparison;
      });
      
      rows.forEach(row => tbody.appendChild(row));
    }

    function populateTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      currentDisplayed = [];

      if (!data || typeof data !== 'object') return;

      // Initial sort by count descending for populating currentDisplayed
      // The actual display sort will be handled by sortTable after this.
      const sortedEntries = Object.entries(data)
        .sort((a, b) => b[1].count - a[1].count); 

      sortedEntries.forEach(([petition, details]) => {
        const row = document.createElement("tr");

        const petitionCell = document.createElement("td");
        const link = document.createElement("a");
        link.href = `https://petition.parliament.uk/petitions/${details.id}`;
        link.textContent = petition;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        petitionCell.appendChild(link);

        const countCell = document.createElement("td");
        countCell.textContent = details.count.toLocaleString("en-UK");
        // No data-value needed for countCell if sortTable parses textContent for numbers

        const ukTotal = getUKTotal(details.id);
        
        const expectedProportion = 1 / 650; 
        const actualProportion = ukTotal > 0 ? (details.count / ukTotal) : 0;
        const salience = ukTotal > 0 ? (actualProportion / expectedProportion) : 0;
        const formattedSalience = salience.toFixed(2);
        
        const salienceCell = document.createElement("td");
        salienceCell.className = "salience-cell";
        salienceCell.textContent = formattedSalience;
        salienceCell.setAttribute("data-value", salience); 
        
        const salienceIndicatorCell = document.createElement("td");
        salienceIndicatorCell.className = "salience-cell";
        const salienceIndicator = document.createElement("div");
        salienceIndicator.className = "salience-arrow " + (salience > 1.0 ? "up" : "down");
        salienceIndicator.innerHTML = salience > 1.0 ? "&#x2191;" : "&#x2193;"; 
        if (Math.abs(salience - 1.0) < 0.01) { // Neutral if very close to 1
             salienceIndicator.innerHTML = ""; // Or some neutral symbol
             salienceIndicator.className = "salience-arrow";
        }
        salienceIndicatorCell.appendChild(salienceIndicator);
        
        const ukTotalCell = document.createElement("td");
        ukTotalCell.className = "details-cell";
        ukTotalCell.textContent = ukTotal ? ukTotal.toLocaleString("en-UK") : "N/A";
        ukTotalCell.setAttribute("data-value", ukTotal || 0);

        const stateCell = document.createElement("td");
        stateCell.className = "details-cell";
        const petitionDetails = getPetitionDetails(details.id);
        stateCell.textContent = petitionDetails?.attributes?.state || "N/A";

        row.appendChild(petitionCell);
        row.appendChild(countCell);
        row.appendChild(salienceCell);
        row.appendChild(salienceIndicatorCell);
        row.appendChild(ukTotalCell);
        row.appendChild(stateCell);

        tbody.appendChild(row);

        currentDisplayed.push({
          petition,
          count: details.count,
          salience: formattedSalience,
          ukTotal,
          state: petitionDetails?.attributes?.state || null
        });
      });
    }

    function getUKTotal(id) {
      const details = getPetitionDetails(id);
      return details?.attributes?.signature_count;
    }

    function getPetitionDetails(id) {
      return rawPetitionsData[id];
    }

    document.getElementById("exportCsvBtn").addEventListener("click", function () {
      if (currentDisplayed.length === 0) return;

      // Use the currently displayed (and sorted) order from the table for CSV
      const tbody = document.querySelector("#dataTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let csvData = [];

      rows.forEach(row => {
          const petitionLink = row.cells[0].querySelector("a");
          const petitionName = petitionLink ? petitionLink.textContent : row.cells[0].textContent;
          const count = row.cells[1].textContent;
          
          let salienceValue = "N/A";
          let ukTotalValue = "N/A";
          let stateValue = "N/A";

          const table = document.getElementById("dataTable");
          if (table.classList.contains("show-details")) {
              salienceValue = row.cells[2].textContent;
              ukTotalValue = row.cells[4].textContent;
              stateValue = row.cells[5].textContent;
          }
          
          csvData.push({
              petition: petitionName,
              count: count.replace(/,/g, ''), // Remove commas for CSV
              salience: salienceValue,
              ukTotal: ukTotalValue.replace(/,/g, ''), // Remove commas for CSV
              state: stateValue
          });
      });


      let csv = "Petition,Count,Salience,UK Total,State\n";
      csvData.forEach(r => {
        csv += `"${r.petition.replace(/"/g, '""')}",${r.count},${r.salience},${r.ukTotal ?? "N/A"},${r.state ?? "N/A"}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "petition_data.csv");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    document.addEventListener("DOMContentLoaded", function() {
      setupSortableColumns();
    });
  </script>

</body>
</html>